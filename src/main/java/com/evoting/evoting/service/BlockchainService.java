package com.evoting.evoting.service;

import java.math.BigInteger;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.web3j.crypto.Credentials;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.core.methods.response.TransactionReceipt;
import org.web3j.protocol.http.HttpService;
import org.web3j.tx.gas.DefaultGasProvider;

import com.evoting.evoting.contract.Voting;

import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class BlockchainService {

    @Value("${web3j.client-address}")
    private String blockchainUrl;

    @Value("${blockchain.private-key}")
    private String privateKey;

    @Value("${blockchain.contract-address}")
    private String contractAddress;

    private Web3j web3j;
    private Credentials credentials;
    private Voting contract; // Wrapper class generated by Web3j

    @PostConstruct
    public void init() {
        try {
            log.info("üîó Connecting to Ethereum blockchain‚Ä¶");

            // Connect to Ganache/Testnet
            web3j = Web3j.build(new HttpService(blockchainUrl));

            // Load account using private key
            credentials = Credentials.create(privateKey);

            log.info("‚úÖ Connected to blockchain as: {}", credentials.getAddress());

            // Load smart contract
            contract = Voting.load(
                    contractAddress,
                    web3j,
                    credentials,
                    new DefaultGasProvider()
            );

            log.info("‚úÖ Smart Contract Loaded: {}", contractAddress);

        } catch (Exception e) {
            log.error("‚ùå Failed to initialize blockchain connection", e);
        }
    }

    // ‚úÖ Send vote to blockchain
    public String castVote(String candidateName) {
        try {
            TransactionReceipt receipt = contract.castVote(candidateName).send();
            String txHash = receipt.getTransactionHash();

            log.info("‚úÖ Vote recorded on blockchain. TxHash: {}", txHash);
            return txHash;

        } catch (Exception e) {
            log.error("‚ùå Blockchain transaction failed", e);
            return null;
        }
    }

    // ‚úÖ Read vote count from blockchain
    public BigInteger getVotes(String candidateName) {
        try {
            return contract.getVotes(candidateName).send();
        } catch (Exception e) {
            log.error("‚ùå Unable to fetch vote count", e);
            return BigInteger.ZERO;
        }
    }

    // ‚úÖ Check if voter already voted (optional)
    public boolean hasAlreadyVoted(String ethAddress) {
        try {
            return contract.hasVoted(ethAddress).send();
        } catch (Exception e) {
            log.error("‚ùå Unable to check vote status", e);
            return false;
        }
    }
}
